---
title: "Weekly10"
author: "Joan_Chiang"
date: "2023-03-23"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(networkD3)
library(htmlwidgets)
```

```{r}
Tran <- read.csv("LBJ_topshot_transactions.csv")
```


```{r}
flowdata <- Tran %>% select(set_name,circulation_count,price_USD,play_category,transaction_timestamp)
unique(flowdata$circulation_count)
mean(flowdata$price_USD)
median(flowdata$price_USD)
quantile(flowdata$price_USD)
mean(flowdata$circulation_count)
median(flowdata$circulation_count)
quantile(flowdata$circulation_count)
flowdata <- flowdata %>% mutate(price=case_when(price_USD<=300~"≤$300",price_USD>=1100~"≥$1100",TRUE~"$300~$1100"))
flowdata <- flowdata %>% mutate(transcation_time=case_when(transaction_timestamp>2021~"2021",transaction_timestamp<2021~"2020"))
flowdata <- flowdata %>% mutate(circulation=case_when(circulation_count<=100~"≤100",circulation_count>=1000~"≥1000",TRUE~"100~1000"))
```

```{r}
networkdata<-flowdata %>% select(set_name,play_category,price,circulation,transcation_time)%>%group_by_all()%>%count%>% rename("transcation_number"="n")
netdf1 <-networkdata %>% ungroup()%>%select("source"= set_name,"target"=play_category,"value"= transcation_number)
netdf2 <-networkdata %>% ungroup()%>%select("source"= play_category,"target"= price,"value"=transcation_number)
netdf3 <-networkdata %>% ungroup()%>%select("source"= price,"target"=circulation,"value"=transcation_number)
netdf4 <-networkdata %>% ungroup()%>%select("source"= circulation,"target"= transcation_time,"value"=transcation_number)
network<-rbind(netdf1,netdf2,netdf3,netdf4)

#check
#test<-flowdata %>% select(Transcation_time,Circulation)%>%group_by_all()%>%count
#sum(flowdata$circulation_count <100)
```




```{r}

nodes <- data.frame(name=c(as.character(networkdata$set_name), 
  as.character(networkdata$play_category),as.character(networkdata$price),as.character(networkdata$circulation),as.character(networkdata$transcation_time)) %>% unique())

network$IDsource <- match(network$source, nodes$name)-1 
network$IDtarget <- match(network$target, nodes$name)-1
p<-sankeyNetwork(Links = network, Nodes = nodes, Source = "IDsource", Target = "IDtarget",Value = "value", NodeID = "name", fontSize = 14, nodeWidth = 10)

p <- htmlwidgets::prependContent(p, htmltools::tags$h3("Transactions for NFTs featuring LeBron James"))
p <- htmlwidgets::prependContent(p, htmltools::tags$p("@JoanChiang, Data: NBA Top Shot Transcaitons"))

htmlwidgets::onRender(p, '
  function(el) { 
    var cols_x = this.sankey.nodes().map(d => d.x).filter((v, i, a) => a.indexOf(v) === i).sort(function(a, b){return a - b});
    var labels = ["Set Name", "Play Category", "Price (USD)","Circulation Num","TRANYear"];
    cols_x.forEach((d, i) => {
      d3.select(el).select("svg")
        .append("text")
        .attr("x", d)
        .attr("y", 12)
        .attr("font-size", 12)
        .text(labels[i]);
    })
  }
')
networkdata %>% as_tibble() %>% rmarkdown::paged_table()

```


